(function(){var a=function(e,c){var g=function(i,h){this.el=e(i);this.zoomFactor=1;this.lastScale=1;this.offset={x:0,y:0};this.options=c.extend(this.defaults,h);this.setupMarkup();this.bindEvents();this.update()},d=function(i,h){return i+h},f=function(i,h){return i>h-0.01&&i<h+0.01};g.prototype={defaults:{tapZoomFactor:2,zoomOutFactor:1.3,animationDuration:300,animationInterval:5,maxZoom:4,minZoom:0.5,use2d:true},handleDragStart:function(h){this.stopAnimation();this.lastDragPosition=false;this.hasInteraction=true;this.handleDrag(h)},handleDrag:function(h){if(this.zoomFactor>1){var i=this.getTouches(h)[0];this.drag(i,this.lastDragPosition);this.offset=this.sanitizeOffset(this.offset);this.lastDragPosition=i}},handleDragEnd:function(){this.end()},handleZoomStart:function(h){this.stopAnimation();this.lastScale=1;this.nthZoom=0;this.lastZoomCenter=false;this.hasInteraction=true},handleZoom:function(i,k){var h=this.getTouchCenter(this.getTouches(i)),j=k/this.lastScale;this.lastScale=k;this.nthZoom+=1;if(this.nthZoom>3){this.scale(j,h);this.drag(h,this.lastZoomCenter)}this.lastZoomCenter=h},handleZoomEnd:function(){this.end()},handleDoubleTap:function(i){var j=this.getTouches(i)[0],h=this.zoomFactor>1?1:this.options.tapZoomFactor,l=this.zoomFactor,k=c.bind(function(m){this.scaleTo(l+m*(h-l),j)},this);if(this.hasInteraction){return}if(l>h){j=this.getCurrentZoomCenter()}this.animate(this.options.animationDuration,this.options.animationInterval,k,this.swing)},sanitizeOffset:function(n){var m=(this.zoomFactor-1)*this.getContainerX(),l=(this.zoomFactor-1)*this.getContainerY(),h=Math.max(m,0),i=Math.max(l,0),k=Math.min(m,0),j=Math.min(l,0);return{x:Math.min(Math.max(n.x,k),h),y:Math.min(Math.max(n.y,j),i)}},scaleTo:function(h,i){this.scale(h/this.zoomFactor,i)},scale:function(i,h){i=this.scaleZoomFactor(i);this.addOffset({x:(i-1)*(h.x+this.offset.x),y:(i-1)*(h.y+this.offset.y)})},scaleZoomFactor:function(i){var h=this.zoomFactor;this.zoomFactor*=i;this.zoomFactor=Math.min(this.options.maxZoom,Math.max(this.zoomFactor,this.options.minZoom));return this.zoomFactor/h},drag:function(i,h){if(h){this.addOffset({x:-(i.x-h.x),y:-(i.y-h.y)})}},getTouchCenter:function(h){return this.getVectorAvg(h)},getVectorAvg:function(h){return{x:c.reduce(c.pluck(h,"x"),d)/h.length,y:c.reduce(c.pluck(h,"y"),d)/h.length}},addOffset:function(h){this.offset={x:this.offset.x+h.x,y:this.offset.y+h.y}},sanitize:function(){if(this.zoomFactor<this.options.zoomOutFactor){this.zoomOutAnimation()}else{if(this.isInsaneOffset(this.offset)){this.sanitizeOffsetAnimation()}}},isInsaneOffset:function(i){var h=this.sanitizeOffset(i);return h.x!==i.x||h.y!==i.y},sanitizeOffsetAnimation:function(){var j=this.sanitizeOffset(this.offset),h={x:this.offset.x,y:this.offset.y},i=c.bind(function(k){this.offset.x=h.x+k*(j.x-h.x);this.offset.y=h.y+k*(j.y-h.y);this.update()},this);this.animate(this.options.animationDuration,this.options.animationInterval,i,this.swing)},zoomOutAnimation:function(){var k=this.zoomFactor,h=1,i=this.getCurrentZoomCenter(),j=c.bind(function(l){this.scaleTo(k+l*(h-k),i)},this);this.animate(this.options.animationDuration,this.options.animationInterval,j,this.swing)},updateAspectRatio:function(){this.setContainerY(this.getContainerX()/this.getAspectRatio())},getInitialZoomFactor:function(){return this.container.width()/this.el.width()},getAspectRatio:function(){return this.el.width()/this.el.height()},getCurrentZoomCenter:function(){var o=this.container.width()*this.zoomFactor,n=this.offset.x,l=o-n-this.container.width(),h=n/l,m=h*this.container.width()/(h+1),q=this.container.height()*this.zoomFactor,p=this.offset.y,j=q-p-this.container.height(),i=p/j,k=i*this.container.height()/(i+1);if(l===0){m=this.container.width()}if(j===0){k=this.container.height()}return{x:m,y:k}},canDrag:function(){return !f(this.zoomFactor,1)},getTouches:function(i){var h=this.container.offset();return c.map(i.touches,function(j){return{x:j.pageX-h.left,y:j.pageY-h.top}})},animate:function(n,i,m,l,k){var h=new Date().getTime(),j=c.bind(function(){if(!this.inAnimation){return}var p=new Date().getTime()-h,o=p/n;if(p>=n){m(1);if(k){k()}this.update();this.stopAnimation();this.update()}else{if(l){o=l(o)}m(o);this.update();setTimeout(j,i)}},this);this.inAnimation=true;j()},stopAnimation:function(){this.inAnimation=false},swing:function(h){return -Math.cos(h*Math.PI)/2+0.5},getContainerX:function(){return this.container.width()},getContainerY:function(){return this.container.height()},setContainerY:function(h){return this.container.height(h)},setupMarkup:function(){this.container=e('<div class="pinch-zoom-container"></div>');this.el.before(this.container);this.container.append(this.el);this.container.css({overflow:"hidden"});this.el.css({webkitTransformOrigin:"0% 0%",mozTransformOrigin:"0% 0%",msTransformOrigin:"0% 0%",oTransformOrigin:"0% 0%",transformOrigin:"0% 0%",position:"absolute"})},end:function(){this.hasInteraction=false;this.sanitize();this.update()},bindEvents:function(){b(this.container.get(0),this);e(window).bind("resize",c.bind(this.update,this));e(this.el).find("img").bind("load",c.bind(this.update,this))},update:function(){if(this.updatePlaned){return}this.updatePlaned=true;setTimeout(c.bind(function(){this.updatePlaned=false;this.updateAspectRatio();var h=this.getInitialZoomFactor()*this.zoomFactor,l=-this.offset.x/h,m=-this.offset.y/h,i="scale3d("+h+", "+h+",1) translate3d("+l+"px,"+m+"px,0px)",k="scale("+h+", "+h+") translate("+l+"px,"+m+"px)",j=c.bind(function(){if(this.clone){this.clone.remove();delete this.clone}},this);if(!this.options.use2d||this.hasInteraction||this.inAnimation){this.is3d=true;j();this.el.css({webkitTransform:i,oTransform:k,msTransform:k,mozTransform:k,transform:i})}else{if(this.is3d){this.clone=this.el.clone();this.clone.css("pointer-events","none");this.clone.appendTo(this.container);setTimeout(j,200)}this.el.css({webkitTransform:k,oTransform:k,msTransform:k,mozTransform:k,transform:k});this.is3d=false}},this),0)}};var b=function(l,j){var t=null,o=0,p=null,u=null,m=function(v,w){if(t!==v){if(t&&!v){switch(t){case"zoom":j.handleZoomEnd(w);break;case"drag":j.handleDragEnd(w);break}}switch(v){case"zoom":j.handleZoomStart(w);break;case"drag":j.handleDragStart(w);break}}t=v},q=function(v){if(o===2){m("zoom")}else{if(o===1&&j.canDrag()){m("drag",v)}else{m(null,v)}}},r=function(v){return c.map(v,function(w){return{x:w.pageX,y:w.pageY}})},k=function(z,w){var v,A;v=z.x-w.x;A=z.y-w.y;return Math.sqrt(v*v+A*A)},n=function(x,y){var w=k(x[0],x[1]),v=k(y[0],y[1]);return v/w},i=function(v){v.stopPropagation();v.preventDefault()},s=function(v){var w=(new Date()).getTime();if(o>1){p=null}if(w-p<300){i(v);j.handleDoubleTap(v);switch(t){case"zoom":j.handleZoomEnd(v);break;case"drag":j.handleDragEnd(v);break}}if(o===1){p=w}},h=true;l.addEventListener("touchstart",function(v){h=true;o=v.touches.length;s(v)});l.addEventListener("touchmove",function(v){if(h){q(v);if(t){i(v)}u=r(v.touches)}else{switch(t){case"zoom":j.handleZoom(v,n(u,r(v.touches)));break;case"drag":j.handleDrag(v);break}if(t){i(v);j.update()}}h=false});l.addEventListener("touchend",function(v){o=v.touches.length;q(v)})};return g};if(typeof define!=="undefined"&&define.amd){define(["jquery","underscore"],function(c,b){return a(c,b)})}else{window.RTP=window.RTP||{};window.RTP.PinchZoom=a(jQuery,_)}}).call(this);